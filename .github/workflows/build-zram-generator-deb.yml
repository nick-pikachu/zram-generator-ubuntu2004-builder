# .github/workflows/build-zram-generator-deb.yml
# This workflow compiles the upstream systemd-zram-generator C project
# and packages it into a .deb file specifically for Ubuntu 20.04.
# It uses a newer GitHub Actions runner (ubuntu-latest) but performs the build
# inside a Docker container running Ubuntu 20.04 to ensure compatibility.
name: Build systemd-zram-generator .deb (Ubuntu 20.04 Target)

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual triggering from the GitHub UI

jobs:
  build_deb:
    name: Build .deb for Ubuntu 20.04 Target
    runs-on: ubuntu-latest # Use the latest supported Ubuntu runner

    container:
      image: ubuntu:20.04 # Run all steps inside an Ubuntu 20.04 Docker container
      options: --user root # Ensure commands run as root inside the container

    steps:
      # Step 1: Checkout YOUR workflow repository.
      - name: Checkout Workflow Repository
        uses: actions/checkout@v4

      # Step 2: Install core tools needed for downloading and extracting
      - name: Install Core Tools (wget, tar) in Container
        run: |
          export DEBIAN_FRONTEND=noninteractive
          apt update -y
          apt install -y wget tar
          apt clean
          rm -rf /var/lib/apt/lists/*

      # Step 3: Download and Extract the *CORRECT* systemd-zram-generator C source directly
      - name: Download and Extract Canonical systemd-zram-generator C source
        run: |
          # The correct repository is systemd/systemd-zram-generator
          # Correct URL for downloading main branch tarball from GitHub
          SOURCE_URL="https://codeload.github.com/systemd/systemd-zram-generator/tar.gz/main"
          TAR_FILE="systemd-zram-generator-main.tar.gz" # Name the downloaded file
          EXTRACT_DIR="systemd-zram-generator-source" # Directory where the source will be extracted

          echo "Downloading $SOURCE_URL..."
          wget -O "$TAR_FILE" "$SOURCE_URL"
          echo "Extracting $TAR_FILE to $EXTRACT_DIR..."
          # The tarball extracts into a directory like systemd-systemd-zram-generator-main/, so we strip components
          mkdir -p "$EXTRACT_DIR"
          tar -xzf "$TAR_FILE" -C "$EXTRACT_DIR" --strip-components=1
          
          # Verify contents immediately after extraction
          echo "Contents of extracted source directory ($EXTRACT_DIR):"
          ls -lF "$EXTRACT_DIR"
          if [ ! -f "$EXTRACT_DIR/meson.build" ]; then
            echo "ERROR: meson.build still not found after wget/extract! This is critically unexpected. Exiting."
            exit 1
          fi
        working-directory: ${{ github.workspace }} # Ensure operations happen from the workspace root

      - name: Install Remaining Build Dependencies inside Ubuntu 20.04 Container (Non-interactive)
        working-directory: ./systemd-zram-generator-source # Now this should contain the C source
        run: |
          export DEBIAN_FRONTEND=noninteractive
          export TZ="Etc/UTC" # Set default timezone to prevent interactive prompts

          apt update -y
          apt install -y tzdata build-essential meson ninja-build pkg-config libsystemd-dev debhelper devscripts
          
          ln -snf /usr/share/zoneinfo/$TZ /etc/localtime
          dpkg-reconfigure -f noninteractive tzdata

          apt clean
          rm -rf /var/lib/apt/lists/*

      - name: Debug:Final Check - List Contents of systemd-zram-generator-source
        working-directory: ./systemd-zram-generator-source # Verify files are here just before build
        run: |
          echo "Current working directory (pwd): $(pwd)"
          echo "Contents of ./systemd-zram-generator-source (FINAL CHECK):"
          ls -lF
          echo "Full recursive listing:"
          ls -lR . 

      - name: Configure and Build Project
        working-directory: ./systemd-zram-generator-source # Meson should find meson.build here
        run: |
          echo "Current working directory for Meson setup: $(pwd)"
          if [ ! -f "meson.build" ]; then
            echo "ERROR: meson.build is still missing! This should not happen. Fatal error. Listing current directory contents:"
            ls -lF .
            exit 1
          fi
          meson setup . build --prefix=/usr # Explicitly tell meson source is '.' and build dir is 'build'
          ninja -C build

      - name: Create Debian Package
        working-directory: ./systemd-zram-generator-source # dpkg-buildpackage operates here
        run: |
          dch --create --package systemd-zram-generator --newversion 1.0.0-${GITHUB_RUN_NUMBER} "GitHub Actions build for Ubuntu 20.04."
          dpkg-buildpackage -b -us -uc

      - name: Find .deb package
        id: find_deb
        run: |
          # The .deb package is created in the parent directory of where dpkg-buildpackage was invoked.
          # Since working-directory for Create Debian Package is './systemd-zram-generator-source',
          # the .deb will be in the root of the runner's workspace.
          # The workspace root inside container is typically /__w/<org>/<repo>/
          DEB_FILE=$(find /__w/${{ github.repository }}/ -maxdepth 2 -name "systemd-zram-generator_*.deb" -print -quit)
          if [ -z "$DEB_FILE" ]; then
            echo "Error: .deb file not found in root workspace! Trying source dir as fallback."
            DEB_FILE=$(find /__w/${{ github.repository }}/systemd-zram-generator-source/ -name "systemd-zram-generator_*.deb" -print -quit)
            if [ -z "$DEB_FILE" ]; then
              echo "Error: .deb file not found anywhere!"
              exit 1
            fi
            echo "Found .deb in source subdirectory (recovered)."
          else
            echo "Found .deb in root workspace (expected)."
          fi
          echo "deb_file=$DEB_FILE" >> $GITHUB_OUTPUT

      - name: Upload Debian Package as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: systemd-zram-generator-ubuntu2004-deb
          path: ${{ steps.find_deb.outputs.deb_file }}
          retention-days: 7
